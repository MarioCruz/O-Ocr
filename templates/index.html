<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to Text Verification Interface</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .btn { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn:hover { background-color: #0056b3; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .main-content { display: flex; gap: 20px; height: 600px; }
        .image-panel, .text-panel { flex: 1; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .image-panel h3, .text-panel h3 { margin-top: 0; color: #333; }
        .image-container { text-align: center; height: 500px; display: flex; align-items: center; justify-content: center; overflow: auto; border: 1px solid #ddd; }
        .image-container img { max-width: 100%; max-height: 100%; object-fit: contain; cursor: zoom-in; transition: transform 0.2s; }
        .image-container img.zoomed { transform: scale(1.65); cursor: zoom-out; }
        .text-area { width: 100%; height: 500px; border: 1px solid #ddd; border-radius: 4px; padding: 10px; font-size: 14px; resize: vertical; }
        .status { text-align: center; margin-top: 20px; padding: 10px; background: #e9ecef; border-radius: 4px; }
        .loading { color: #007bff; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 800px; max-height: 80%; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .help-section { margin-bottom: 20px; }
        .help-section h3 { color: #007bff; margin-bottom: 10px; }
        .filename-example { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; margin: 5px 0; }
        .theme-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .theme-item { background: #e9ecef; padding: 8px; border-radius: 4px; }
        .theme-name { font-weight: bold; color: #495057; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Image to Text Verification Interface</h1>
            <p>Convert handwritten student poems to digital text using Groq API</p>
        </div>
        
        <div class="controls">
            <input type="file" id="fileInput" accept="image/*,.pdf,.heic,.heif" style="display: none;" onchange="uploadImage()">
            <button class="btn" onclick="document.getElementById('fileInput').click()">Upload Image</button>
            <button class="btn" onclick="previousImage()">Previous</button>
            <button class="btn" onclick="nextImage()">Next</button>
            <button class="btn" onclick="rotateImage('left')" style="background-color: #6c757d;">‚Ü∫ Rotate Left</button>
            <button class="btn" onclick="rotateImage('right')" style="background-color: #6c757d;">‚Üª Rotate Right</button>
            <select id="processingMode" style="padding: 10px; margin: 0 10px; border: 1px solid #ddd; border-radius: 4px;" onchange="saveProcessingMode()">
                <option value="poem">Student Poems (SUN Room)</option>
                <option value="freeform">Free Form OCR</option>
                <option value="zip_ode_explain">Zipcode (Zip Ode)</option>
                <option value="custom_poem">Custom Poem</option>
                <option value="postcard_poem">Post Card Poem</option>
                <option value="worksheet_poem">Worksheet Poem</option>
                <option value="survey_form">Non-Poem Survey Form</option>
            </select>
            <button class="btn" onclick="showCustomSettings()" style="background-color: #6f42c1;">Custom Settings</button>
            <button class="btn" onclick="convertToText()">Convert to Text</button>
            <button class="btn" onclick="saveText()">Save Text</button>
            <button class="btn" onclick="batchProcess()" style="background-color: #28a745;">Batch Process All</button>
            <button class="btn" onclick="showApiKeyModal()" style="background-color: #ffc107;">API Key</button>
            <button class="btn" onclick="clearAllDrafts()" style="background-color: #dc3545;">Clear Drafts</button>
            <button class="btn" onclick="showFileList()" style="background-color: #6c757d;">üìÇ View Files</button>
            <button class="btn" onclick="downloadAllFiles()" style="background-color: #6f42c1;">üìÅ Download All Files</button>
            <button class="btn" onclick="showHelp()" style="background-color: #17a2b8;">Help</button>
        </div>
        
        <div class="main-content">
            <div class="image-panel">
                <h3>Original Image <span id="convertedIndicator" style="color: #007bff; font-size: 14px;"></span></h3>
                <div class="image-container" id="imageContainer">
                    <p>Click "Upload Image" to load an image file</p>
                </div>
            </div>
            
            <div class="text-panel">
                <h3>Converted Text (Editable) <span id="confidenceScore" style="color: #28a745; font-size: 14px;"></span><span id="savedIndicator" style="color: #28a745; font-size: 14px; margin-left: 10px;"></span></h3>
                <textarea class="text-area" id="textArea" placeholder="Converted text will appear here..."></textarea>
            </div>
        </div>
        
        <div class="status" id="status">Ready</div>
        
        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 12px;">
            Version 1.0.0<br>
            Made with ‚ù§Ô∏è by MarioTheMaker for O, Miami<br>
            <span style="font-family: monospace; background: #f0f0f0; padding: 2px 4px; border-radius: 3px;">~/O-Ocr/</span>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHelp()">&times;</span>
            <h2>üìö Image to Text Help Guide</h2>
            
            <div class="help-section">
                <h3>üéØ How to Use</h3>
                <p><strong>1. Upload files:</strong> Click "Upload Image" to add PDFs or images</p>
                <p><strong>2. Select mode:</strong> Choose processing mode (Student Poems, Free Form OCR, Zipcode, Custom)</p>
                <p><strong>3. Navigate:</strong> Use Previous/Next to browse through files</p>
                <p><strong>4. Convert:</strong> Click "Convert to Text" to transcribe current image</p>
                <p><strong>5. Review:</strong> Check AI confidence score next to "Converted Text"</p>
                <p><strong>6. Edit:</strong> Modify the transcribed text in the right panel</p>
                <p><strong>7. Save:</strong> Click "Save Text" to create file with metadata</p>
                <p><strong>8. Batch process:</strong> Click "Batch Process All" to convert all uploaded files</p>
            </div>

            <div class="help-section">
                <h3>üîÑ Bulk Conversion</h3>
                <p>Process multiple files at once with intelligent naming:</p>
                <p><strong>‚Ä¢ Upload multiple files:</strong> Add images and PDFs to the uploads folder</p>
                <p><strong>‚Ä¢ Click "Batch Process All":</strong> Converts all files automatically</p>
                <p><strong>‚Ä¢ AI extraction:</strong> Automatically identifies student names, schools, poem titles, and themes</p>
                <p><strong>‚Ä¢ Organized output:</strong> Creates meaningful filenames for easy sorting</p>
                <p><strong>‚Ä¢ Progress tracking:</strong> Shows completion status and file count</p>
                <p><strong>‚Ä¢ Error handling:</strong> Continues processing even if some files fail</p>
                <p><strong>‚Ä¢ Summary report:</strong> Generates batch_results.json with processing details</p>
            </div>

            <div class="help-section">
                <h3>üìÅ Smart File Naming</h3>
                <p>Files are automatically named using information extracted from the poem:</p>
                <div class="filename-example">{School}_{Student}_{Poem_Title}_{Theme}.txt</div>
                
                <p><strong>Examples:</strong></p>
                <div class="filename-example">Lincoln_Elementary_Maria_Garcia_Ocean_Dreams_nature.txt</div>
                <div class="filename-example">Roosevelt_Middle_John_Smith_My_Family_family.txt</div>
                <div class="filename-example">Washington_High_Sarah_Johnson_Best_Friend_friendship.txt</div>
            </div>

            <div class="help-section">
                <h3>üè∑Ô∏è AI Theme Detection</h3>
                <p>The AI automatically identifies poem themes by understanding content:</p>
                <div class="theme-list">
                    <div class="theme-item">
                        <div class="theme-name">Family</div>
                        <div>Poems about relatives, parents, siblings, home life</div>
                    </div>
                    <div class="theme-item">
                        <div class="theme-name">Nature</div>
                        <div>Poems about outdoors, animals, weather, plants</div>
                    </div>
                    <div class="theme-item">
                        <div class="theme-name">Friendship</div>
                        <div>Poems about friends, playing together, kindness</div>
                    </div>
                    <div class="theme-item">
                        <div class="theme-name">School</div>
                        <div>Poems about learning, teachers, classroom activities</div>
                    </div>
                    <div class="theme-item">
                        <div class="theme-name">Emotions</div>
                        <div>Poems expressing feelings, moods, reactions</div>
                    </div>
                    <div class="theme-item">
                        <div class="theme-name">Seasons</div>
                        <div>Poems about weather, seasonal activities, holidays</div>
                    </div>
                    <div class="theme-item">
                        <div class="theme-name">Miami</div>
                        <div>Poems about Miami, Florida, beaches, city life, local culture</div>
                    </div>
                    <div class="theme-item">
                        <div class="theme-name">Sun</div>
                        <div>Poems about sunshine, warmth, light</div>
                    </div>
                </div>
            </div>

            <div class="help-section">
                <h3>üîÑ Processing Modes</h3>
                <p><strong>Student Poems (SUN Room):</strong> Standard poem transcription with metadata</p>
                <p><strong>Free Form OCR:</strong> General text transcription for any document</p>
                <p><strong>Zipcode (Zip Ode):</strong> Special format for O, Miami's Zip Ode poems</p>
                <p><strong>Custom Poem:</strong> User-configurable document structure</p>
                <p><strong>Post Card Poem:</strong> Transcribes poems written on postcards with postcard-specific metadata</p>
                <p><strong>Worksheet Poem:</strong> Processes educational worksheets containing poems with worksheet type identification</p>
                <p><strong>Non-Poem Survey Form:</strong> Transcribes survey forms, questionnaires, and feedback forms</p>
            </div>

            <div class="help-section">
                <h3>üìã Supported Formats</h3>
                <p><strong>Input:</strong> PNG, JPG, JPEG, GIF, BMP, TIFF, PDF, HEIC, HEIF</p>
                <p><strong>Output:</strong> UTF-8 encoded .txt files</p>
                <p><strong>File size limit:</strong> 50MB maximum</p>
            </div>

            <div class="help-section">
                <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
                <p><strong>‚Üê ‚Üí</strong> Navigate between images</p>
                <p><strong>Ctrl + Enter</strong> Convert to text</p>
                <p><strong>Ctrl + S</strong> Save text</p>
            </div>

            <div class="help-section">
                <h3>üí° Tips</h3>
                <p>‚Ä¢ Check AI confidence score - higher scores indicate more accurate transcription</p>
                <p>‚Ä¢ Text is auto-saved every 30 seconds as you type</p>
                <p>‚Ä¢ Click on images to zoom in/out for better readability</p>
                <p>‚Ä¢ PDF files are automatically split into individual pages</p>
                <p>‚Ä¢ AI automatically extracts metadata (POEM_TITLE, POEM_THEME) for organization</p>
                <p>‚Ä¢ Batch processing creates meaningful filenames using AI-identified information</p>
                <p>‚Ä¢ Files are organized in separate upload and output directories</p>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeApiKeyModal()">&times;</span>
            <h2>üîë Groq API Settings</h2>
            <p>Enter your Groq API key and select model:</p>
            <input type="password" id="apiKeyInput" placeholder="Enter your Groq API key" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;" onblur="loadModelsFromInput()">
            <select id="modelSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                <option value="meta-llama/llama-4-scout-17b-16e-instruct">Llama 4 Scout 17B (Default)</option>
                <option value="llama-3.2-90b-vision-preview">Llama 3.2 90B Vision</option>
                <option value="llama-3.2-11b-vision-preview">Llama 3.2 11B Vision</option>
            </select>
            <div style="margin-top: 15px;">
                <button class="btn" onclick="saveApiKey()" style="background-color: #28a745;">Save Settings</button>
                <button class="btn" onclick="clearApiKey()" style="background-color: #dc3545;">Clear Settings</button>
            </div>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">Your API key is stored locally in your browser and never sent to our servers except for API calls.</p>
        </div>
    </div>

    <!-- Custom Settings Modal -->
    <div id="customSettingsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeCustomSettings()">&times;</span>
            <h2>‚öôÔ∏è Custom Poem Settings</h2>
            <p>Configure what the AI should look for in your custom poem documents:</p>
            
            <label style="display: block; margin: 10px 0 5px 0; font-weight: bold;">Name:</label>
            <input type="text" id="customName" placeholder="Custom Poem" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            
            <label style="display: block; margin: 10px 0 5px 0; font-weight: bold;">Description:</label>
            <input type="text" id="customDescription" placeholder="User-defined poem structure and content" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            
            <label style="display: block; margin: 10px 0 5px 0; font-weight: bold;">Poem Structure:</label>
            <input type="text" id="customStructure" placeholder="Free verse with custom requirements" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            
            <label style="display: block; margin: 10px 0 5px 0; font-weight: bold;">Document Contains (comma-separated):</label>
            <input type="text" id="customContains" placeholder="Student name, School name, Poem text" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            
            <div style="margin-top: 15px;">
                <button class="btn" onclick="saveCustomSettings()" style="background-color: #28a745;">Save Settings</button>
                <button class="btn" onclick="resetCustomSettings()" style="background-color: #dc3545;">Reset to Default</button>
            </div>
            
            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 15px; font-size: 12px;">
                <strong>Examples:</strong><br>
                Structure: "Haiku with 5-7-5 syllables"<br>
                Contains: "Student name, Grade level, Haiku poem, Date"
            </div>
        </div>
    </div>

    <script>
        let currentFilename = '';
        
        function updateStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }
        
        function loadImage() {
            updateStatus('Loading image...', 'loading');
            fetch('/get_image_info')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        if (data.error === 'No images found') {
                            document.getElementById('imageContainer').innerHTML = '<p style="color: #666;">No images found. Click "Upload Image" to add images.</p>';
                            updateStatus('No images found', 'error');
                        } else {
                            updateStatus(data.error, 'error');
                        }
                        return;
                    }
                    
                    if (!data.image_base64) {
                        updateStatus('Invalid image data received', 'error');
                        return;
                    }
                    
                    const imageContainer = document.getElementById('imageContainer');
                    imageContainer.innerHTML = `<img src="data:image/jpeg;base64,${data.image_base64}" alt="${data.filename}" onclick="toggleZoom(this)">`;
                    
                    currentFilename = data.filename;
                    updateStatus(`Image ${data.index}/${data.total}: ${data.filename}`);
                    loadDraft(data.filename);
                })
                .catch(error => {
                    console.error('Error loading image:', error);
                    updateStatus(`Failed to load image: ${error.message}`, 'error');
                    document.getElementById('imageContainer').innerHTML = '<p style="color: #dc3545;">Error loading image. Check console for details.</p>';
                });
        }
        
        function previousImage() {
            fetch('/navigate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ direction: 'prev' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    updateStatus(data.error, 'error');
                    return;
                }
                
                const imageContainer = document.getElementById('imageContainer');
                imageContainer.innerHTML = `<img src="data:image/jpeg;base64,${data.image_base64}" alt="${data.filename}" onclick="toggleZoom(this)">`;
                
                currentFilename = data.filename;
                updateStatus(`Image ${data.index}/${data.total}: ${data.filename}`);
                
                // Clear text area and load draft
                document.getElementById('textArea').value = '';
                document.getElementById('savedIndicator').textContent = '';
                document.getElementById('convertedIndicator').textContent = '';
                document.getElementById('confidenceScore').textContent = '';
                loadDraft(data.filename);
            });
        }
        
        function nextImage() {
            fetch('/navigate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ direction: 'next' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    updateStatus(data.error, 'error');
                    return;
                }
                
                const imageContainer = document.getElementById('imageContainer');
                imageContainer.innerHTML = `<img src="data:image/jpeg;base64,${data.image_base64}" alt="${data.filename}" onclick="toggleZoom(this)">`;
                
                currentFilename = data.filename;
                updateStatus(`Image ${data.index}/${data.total}: ${data.filename}`);
                
                // Clear text area and load draft
                document.getElementById('textArea').value = '';
                document.getElementById('savedIndicator').textContent = '';
                document.getElementById('convertedIndicator').textContent = '';
                document.getElementById('confidenceScore').textContent = '';
                loadDraft(data.filename);
            });
        }
        
        function convertToText() {
            const apiKey = localStorage.getItem('groq_api_key');
            if (!apiKey) {
                updateStatus('Please set your Groq API key first', 'error');
                showApiKeyModal();
                return;
            }
            
            const convertBtn = document.querySelector('button[onclick="convertToText()"]');
            convertBtn.disabled = true;
            convertBtn.innerHTML = '<span class="spinner"></span>Converting...';
            updateStatus('Converting image to text...', 'loading');
            
            const model = localStorage.getItem('groq_model') || 'meta-llama/llama-4-scout-17b-16e-instruct';
            const processingMode = document.getElementById('processingMode').value;
            
            fetch('/convert_text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_key: apiKey, model: model, processing_mode: processingMode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    updateStatus(data.error, 'error');
                    return;
                }
                
                document.getElementById('textArea').value = data.text;
                
                // Display confidence score
                const confidenceElement = document.getElementById('confidenceScore');
                if (data.confidence_score) {
                    confidenceElement.textContent = `(${data.confidence_score})`;
                } else {
                    confidenceElement.textContent = '';
                }
                
                // Store student name, school, poem title, theme, and language for filename
                window.currentStudentName = data.student_name || '';
                window.currentSchoolName = data.school_name || '';
                window.currentPoemTitle = data.poem_title || '';
                window.currentPoemTheme = data.poem_theme || '';
                window.currentPoemLanguage = data.poem_language || '';
                
                updateStatus('Conversion completed successfully', 'success');
            })
            .catch(error => {
                updateStatus('Conversion failed', 'error');
            })
            .finally(() => {
                convertBtn.disabled = false;
                convertBtn.innerHTML = 'Convert to Text';
            });
        }
        
        function saveText() {
            const text = document.getElementById('textArea').value;
            
            if (!text.trim()) {
                updateStatus('No text to save', 'error');
                return;
            }
            
            const saveBtn = document.querySelector('button[onclick="saveText()"]');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner"></span>Saving...';
            updateStatus('Saving text and moving image...', 'loading');
            
            fetch('/save_text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    text: text,
                    student_name: window.currentStudentName || '',
                    school_name: window.currentSchoolName || '',
                    poem_title: window.currentPoemTitle || '',
                    poem_theme: window.currentPoemTheme || '',
                    poem_language: window.currentPoemLanguage || '',
                    filename: currentFilename
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    updateStatus(data.error, 'error');
                    return;
                }
                
                // Clear current display immediately
                document.getElementById('textArea').value = '';
                document.getElementById('savedIndicator').textContent = '';
                document.getElementById('convertedIndicator').textContent = '';
                document.getElementById('confidenceScore').textContent = '';
                
                // Clear draft from localStorage since file was saved
                if (currentFilename) {
                    localStorage.removeItem('draft_' + currentFilename);
                }
                
                // Clear current student info variables
                window.currentStudentName = '';
                window.currentSchoolName = '';
                window.currentPoemTitle = '';
                window.currentPoemTheme = '';
                window.currentPoemLanguage = '';
                
                // Handle no more images case
                if (data.no_more_images) {
                    document.getElementById('imageContainer').innerHTML = '<p style="color: #28a745; font-weight: bold;">üéâ All images processed!<br><br>Upload more images to continue.</p>';
                    updateStatus('üéâ ' + data.message, 'success');
                } else {
                    document.getElementById('imageContainer').innerHTML = '<p>Loading next image...</p>';
                    // Force refresh the image list from server before loading next image
                    setTimeout(() => {
                        // Force refresh by calling the server to get updated image list
                        fetch('/get_image_info')
                            .then(response => response.json())
                            .then(data => {
                                if (data.error) {
                                    if (data.error === 'No images found') {
                                        document.getElementById('imageContainer').innerHTML = '<p style="color: #28a745; font-weight: bold;">üéâ All images processed!<br><br>Upload more images to continue.</p>';
                                        updateStatus('üéâ All images processed! No more images in upload directory.', 'success');
                                    } else {
                                        updateStatus(data.error, 'error');
                                    }
                                    return;
                                }
                                
                                const imageContainer = document.getElementById('imageContainer');
                                imageContainer.innerHTML = `<img src="data:image/jpeg;base64,${data.image_base64}" alt="${data.filename}" onclick="toggleZoom(this)">`;
                                
                                currentFilename = data.filename;
                                updateStatus(`‚úÖ File saved and moved! Now showing: Image ${data.index}/${data.total}: ${data.filename}`, 'success');
                                loadDraft(data.filename);
                            })
                            .catch(error => {
                                updateStatus('Failed to load next image', 'error');
                            });
                    }, 100);
                }
            })
            .catch(error => {
                updateStatus('Save failed', 'error');
            })
            .finally(() => {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save Text';
            });
        }
        
        function toggleZoom(img) {
            img.classList.toggle('zoomed');
        }
        

        
        function uploadImage() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            const uploadBtn = document.querySelector('button[onclick="document.getElementById(\'fileInput\').click()"]');
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="spinner"></span>Uploading...';
            updateStatus('Uploading image...', 'loading');
            
            fetch('/upload_image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    updateStatus(data.error, 'error');
                    return;
                }
                
                const imageContainer = document.getElementById('imageContainer');
                imageContainer.innerHTML = `<img src="data:image/jpeg;base64,${data.image_base64}" alt="${data.filename}" onclick="toggleZoom(this)">`;
                
                currentFilename = data.filename;
                updateStatus(`Image ${data.index}/${data.total}: ${data.filename}`);
                
                document.getElementById('textArea').value = '';
                loadDraft(data.filename);
            })
            .catch(error => {
                updateStatus('Upload failed', 'error');
            })
            .finally(() => {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = 'Upload Image';
            });
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') previousImage();
            if (e.key === 'ArrowRight') nextImage();
            if (e.key === 'Enter' && e.ctrlKey) convertToText();
            if (e.key === 's' && e.ctrlKey) { e.preventDefault(); saveText(); }
        });
        
        // Auto-save text every 30 seconds
        setInterval(function() {
            const text = document.getElementById('textArea').value;
            if (text.trim() && currentFilename && currentFilename !== '') {
                try {
                    localStorage.setItem('draft_' + currentFilename, text);
                } catch (e) {
                    // If localStorage is full, clean up and try again
                    if (e.name === 'QuotaExceededError') {
                        console.warn('localStorage quota exceeded, cleaning up drafts');
                        cleanupOldDrafts();
                        try {
                            localStorage.setItem('draft_' + currentFilename, text);
                        } catch (e2) {
                            console.error('Still cannot save draft after cleanup:', e2);
                            updateStatus('Warning: Cannot save draft - storage full', 'error');
                        }
                    }
                }
            }
        }, 30000);
        
        // Load draft when switching images
        function loadDraft(filename) {
            try {
                const draft = localStorage.getItem('draft_' + filename);
                if (draft) {
                    document.getElementById('textArea').value = draft;
                    updateStatus('Draft loaded', 'success');
                }
            } catch (e) {
                console.error('Error loading draft:', e);
                // Remove problematic draft
                try {
                    localStorage.removeItem('draft_' + filename);
                } catch (e2) {
                    console.error('Error removing problematic draft:', e2);
                }
            }
        }
        
        // Clean up old drafts from localStorage
        function cleanupOldDrafts() {
            const keys = Object.keys(localStorage);
            const draftKeys = keys.filter(key => key.startsWith('draft_'));
            
            // Remove drafts older than 7 days
            const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            
            draftKeys.forEach(key => {
                try {
                    const item = localStorage.getItem(key);
                    if (item) {
                        // Check if we can determine age, otherwise remove very old drafts
                        const draftCount = draftKeys.length;
                        if (draftCount > 50) { // If too many drafts, clean up
                            localStorage.removeItem(key);
                            console.log('Removed old draft:', key);
                        }
                    }
                } catch (e) {
                    // If there's an error, remove the problematic key
                    localStorage.removeItem(key);
                }
            });
        }
        
        // Clear all drafts function for manual cleanup
        function clearAllDrafts() {
            const keys = Object.keys(localStorage);
            const draftKeys = keys.filter(key => key.startsWith('draft_'));
            
            draftKeys.forEach(key => {
                localStorage.removeItem(key);
            });
            
            updateStatus(`Cleared ${draftKeys.length} draft(s) from storage`, 'success');
        }
        
        function showHelp() {
            document.getElementById('helpModal').style.display = 'block';
        }
        
        function closeHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }
        
        function showApiKeyModal() {
            try {
                const savedApiKey = localStorage.getItem('groq_api_key');
                const savedModel = localStorage.getItem('groq_model');
                document.getElementById('apiKeyInput').value = savedApiKey || '';
                document.getElementById('modelSelect').value = savedModel || 'meta-llama/llama-4-scout-17b-16e-instruct';
                document.getElementById('apiKeyModal').style.display = 'block';
                
                if (savedApiKey) {
                    loadModels(savedApiKey);
                }
            } catch (e) {
                console.error('Error loading API settings:', e);
                document.getElementById('apiKeyModal').style.display = 'block';
            }
        }
        
        function loadModels(apiKey) {
            fetch('/get_models', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                if (data.models) {
                    const select = document.getElementById('modelSelect');
                    const currentValue = select.value;
                    select.innerHTML = '';
                    
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        select.appendChild(option);
                    });
                    
                    select.value = currentValue;
                }
            })
            .catch(error => console.log('Failed to load models'));
        }
        
        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'none';
        }
        
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const model = document.getElementById('modelSelect').value;
            if (apiKey) {
                try {
                    localStorage.setItem('groq_api_key', apiKey);
                    localStorage.setItem('groq_model', model);
                    updateStatus('Settings saved successfully', 'success');
                } catch (e) {
                    console.error('Error saving API settings:', e);
                    updateStatus('Error saving settings - storage may be full', 'error');
                }
            } else {
                updateStatus('Please enter a valid API key', 'error');
            }
            closeApiKeyModal();
        }
        
        function clearApiKey() {
            try {
                localStorage.removeItem('groq_api_key');
                localStorage.removeItem('groq_model');
                document.getElementById('apiKeyInput').value = '';
                document.getElementById('modelSelect').value = 'meta-llama/llama-4-scout-17b-16e-instruct';
                updateStatus('Settings cleared', 'success');
            } catch (e) {
                console.error('Error clearing API settings:', e);
                updateStatus('Error clearing settings', 'error');
            }
            closeApiKeyModal();
        }
        
        function loadModelsFromInput() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey) {
                loadModels(apiKey);
            }
        }
        
        function showCustomSettings() {
            loadCustomSettings();
            document.getElementById('customSettingsModal').style.display = 'block';
        }
        
        function closeCustomSettings() {
            document.getElementById('customSettingsModal').style.display = 'none';
        }
        
        function loadCustomSettings() {
            fetch('/get_custom_settings')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('customName').value = data.name || '';
                    document.getElementById('customDescription').value = data.description || '';
                    document.getElementById('customStructure').value = data.structure || '';
                    document.getElementById('customContains').value = data.document_contains ? data.document_contains.join(', ') : '';
                })
                .catch(error => console.log('Failed to load custom settings'));
        }
        
        function saveCustomSettings() {
            const settings = {
                name: document.getElementById('customName').value,
                description: document.getElementById('customDescription').value,
                structure: document.getElementById('customStructure').value,
                document_contains: document.getElementById('customContains').value.split(',').map(s => s.trim()).filter(s => s)
            };
            
            fetch('/save_custom_settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    updateStatus(data.error, 'error');
                } else {
                    updateStatus('Custom settings saved successfully', 'success');
                    closeCustomSettings();
                }
            })
            .catch(error => {
                updateStatus('Failed to save custom settings', 'error');
            });
        }
        
        function resetCustomSettings() {
            document.getElementById('customName').value = 'Custom Poem';
            document.getElementById('customDescription').value = 'User-defined poem structure and content';
            document.getElementById('customStructure').value = 'Free verse with custom requirements';
            document.getElementById('customContains').value = 'Student name, School name, Poem text';
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const helpModal = document.getElementById('helpModal');
            const apiKeyModal = document.getElementById('apiKeyModal');
            const customModal = document.getElementById('customSettingsModal');
            if (event.target == helpModal) {
                helpModal.style.display = 'none';
            }
            if (event.target == apiKeyModal) {
                apiKeyModal.style.display = 'none';
            }
            if (event.target == customModal) {
                customModal.style.display = 'none';
            }
        }
        
        function batchProcess() {
            const apiKey = localStorage.getItem('groq_api_key');
            if (!apiKey) {
                updateStatus('Please set your Groq API key first', 'error');
                showApiKeyModal();
                return;
            }
            
            if (!confirm('Process all images in uploads folder? This may take a while.')) {
                return;
            }
            
            const batchBtn = document.querySelector('button[onclick="batchProcess()"]');
            batchBtn.disabled = true;
            batchBtn.innerHTML = '<span class="spinner"></span>Processing...';
            updateStatus('Starting batch processing...', 'loading');
            
            fetch('/batch_process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    updateStatus(data.error, 'error');
                    return;
                }
                
                updateStatus(data.success, 'success');
            })
            .catch(error => {
                updateStatus('Batch processing failed', 'error');
            })
            .finally(() => {
                batchBtn.disabled = false;
                batchBtn.innerHTML = 'Batch Process All';
            });
        }
        
        function saveProcessingMode() {
            const mode = document.getElementById('processingMode').value;
            try {
                localStorage.setItem('processing_mode', mode);
            } catch (e) {
                console.error('Error saving processing mode:', e);
            }
        }
        
        function loadProcessingMode() {
            try {
                const savedMode = localStorage.getItem('processing_mode');
                if (savedMode) {
                    document.getElementById('processingMode').value = savedMode;
                }
            } catch (e) {
                console.error('Error loading processing mode:', e);
            }
        }
        
        function rotateImage(direction) {
            fetch('/rotate_image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ direction: direction })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    updateStatus(data.error, 'error');
                    return;
                }
                
                const imageContainer = document.getElementById('imageContainer');
                imageContainer.innerHTML = `<img src="data:image/jpeg;base64,${data.image_base64}" alt="${data.filename}" onclick="toggleZoom(this)">`;
                updateStatus('Image rotated successfully', 'success');
            })
            .catch(error => {
                updateStatus('Rotation failed', 'error');
            });
        }
        
        function setDownloadDirectory() {
            alert('Files are automatically saved inside the container. Use the Download Files button to get them.');
        }
        
        function downloadAllFiles() {
            const link = document.createElement('a');
            link.href = '/download_all_zip';
            link.download = 'converted_poems.zip';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            updateStatus('Downloading all files as zip...', 'success');
        }
        
        function showFileList() {
            fetch('/list_files')
                .then(response => response.json())
                .then(data => {
                    if (data.files && data.files.length > 0) {
                        let fileList = 'Files in container:\n\n';
                        data.files.forEach(file => {
                            const date = new Date(file.modified * 1000).toLocaleString();
                            const size = (file.size / 1024).toFixed(1) + ' KB';
                            fileList += `${file.name} (${size}, ${date})\n`;
                        });
                        alert(fileList);
                    } else {
                        alert('No files found in container');
                    }
                })
                .catch(error => {
                    updateStatus('Failed to list files', 'error');
                });
        }
        

        
        // Load first image on page load
        window.onload = function() {
            loadProcessingMode();
            cleanupOldDrafts(); // Clean up old drafts on page load
            loadImage();
        };
    </script>
</body>
</html>